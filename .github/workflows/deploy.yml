name: ssh

on:
  push:
    branches:
      - main

jobs:
  - name: Discord Notification - Start
    uses: sarisia/actions-status-discord@v1
    with:
      webhook: ${{ secrets.DISCORD_WEBHOOK }}
      title: "üöÄ Î∞∞Ìè¨ ÏãúÏûë"
      description: |
        Repository: ${{ github.repository }}
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.event.head_commit.message }}
      color: 0x0000ff

    ssh-agent: # Job Ïù¥Î¶Ñ
      runs-on: ubuntu-24.04 # GitHub ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ ÌôòÍ≤Ω

      steps: # Ïã§ÌñâÌï† ÏûëÏóÖ(step)
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Create .env file
          run: |
            echo "DATABASE_HOST=${{ secrets.DATABASE_HOST }}" >> .env
            echo "DATABASE_NAME=${{ secrets.DATABASE_NAME }}" >> .env
            echo "DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}" >> .env
            echo "DATABASE_PORT=${{ secrets.DATABASE_PORT }}" >> .env
            echo "DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}" >> .env
            echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}" >> .env
            echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> .env

        - name: Add Remote Server Fingerprint to Known Hosts
          run: ssh-keyscan -H -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts || true

        - name: Login DockerHub
          run: echo '${{ secrets.DOCKER_PASSWORD}}' | docker login -u '${{ secrets.DOCKER_USERNAME }}' --password-stdin

        - name: Docker Image Build
          run: docker compose -f docker-compose.yml build

        - name: Docker Image Push
          run: docker compose -f docker-compose.yml push

        - name: Copy .env / docker-compose.yml
          uses: appleboy/scp-action@v0.1.7
          with:
            host: ${{ secrets.SSH_HOST }}
            username: ${{ secrets.SSH_USERNAME }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            port: ${{ secrets.SSH_PORT }}
            source: "docker-compose.yml,.env"
            target: "~/github-actions-work-directory"

        - name: Pull Image & Up Container
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.SSH_HOST }}
            username: ${{ secrets.SSH_USERNAME }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            port: ${{ secrets.SSH_PORT }}
            script: |
              cd ~/github-actions-work-directory
              docker compose -f docker-compose.yml pull
              docker compose -f docker-compose.yml down
              docker compose -f docker-compose.yml up -d

        # Discord ÏïåÎ¶º - Î∞∞Ìè¨ ÏÑ±Í≥µ
        - name: Discord Notification - Success
          if: success()
          uses: sarisia/actions-status-discord@v1
          with:
            webhook: ${{ secrets.DISCORD_WEBHOOK }}
            title: "‚úÖ Î∞∞Ìè¨ ÏÑ±Í≥µ"
            description: |
              Repository: ${{ github.repository }}
              Branch: ${{ github.ref_name }}
              Commit: ${{ github.event.head_commit.message }}
            color: 0x00ff00

        # Discord ÏïåÎ¶º - Î∞∞Ìè¨ Ïã§Ìå®
        - name: Discord Notification - Failure
          if: failure()
          uses: sarisia/actions-status-discord@v1
          with:
            webhook: ${{ secrets.DISCORD_WEBHOOK }}
            title: "‚ùå Î∞∞Ìè¨ Ïã§Ìå®"
            description: |
              Repository: ${{ github.repository }}
              Branch: ${{ github.ref_name }}
              Commit: ${{ github.event.head_commit.message }}
            color: 0xff0000
