name: ssh # GitHub Actionsì˜ Workflow ì´ë¦„

on:
  push:
    branches:
      - main # main ë¸Œëœì¹˜ì— pushë  ë•Œ ì‹¤í–‰
    paths:
      - ".github/workflows/deploy.yml" # Workflow íŒŒì¼ì´ ë³€ê²½ë  ë•Œ ì‹¤í–‰
      - "docker-compose.yml" # docker-compose.yml ë³€ê²½ ì‹œ ì‹¤í–‰
      - "Dockerfile" # Dockerfile ë³€ê²½ ì‹œ ì‹¤í–‰
      - "client/**" # í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ ë³€ê²½ ì‹œ ì‹¤í–‰
      - "api/**" # API ì„œë²„ ì½”ë“œ ë³€ê²½ ì‹œ ì‹¤í–‰

jobs:
  ssh-agent:
    runs-on: ubuntu-24.04 # GitHub Actions ì‹¤í–‰ í™˜ê²½ (Ubuntu 24.04)

    steps:
      # 1ï¸âƒ£ Discord ì•Œë¦¼ (ë°°í¬ ì‹œì‘)
      - name: Discord Notification - Start
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ğŸš€ ë°°í¬ ì‹œì‘"
          description: |
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.event.head_commit.message }}
          color: 0x0000ff

      # 2ï¸âƒ£ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (GitHub Actions í™˜ê²½ì— ì½”ë“œ ë‹¤ìš´ë¡œë“œ)
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      # 3ï¸âƒ£ Docker ìºì‹± ì„¤ì • (ë¹Œë“œ ì†ë„ ìµœì í™”ë¥¼ ìœ„í•´)
      - name: Set Up Cache Repo
        uses: actions/cache@v4.2.0
        with:
          path: /tmp/.docker-cache
          key: docker-cache-${{ github.sha }}
          restore-keys: docker-cache-

      # 4ï¸âƒ£ SSH ì—ì´ì „íŠ¸ ì„¤ì • (ì›ê²© ì„œë²„ ì ‘ê·¼ì„ ìœ„í•´)
      - name: SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 5ï¸âƒ£ ì›ê²© ì„œë²„ì˜ SSH í‚¤ë¥¼ ë“±ë¡ (ì„œë²„ì˜ í˜¸ìŠ¤íŠ¸ í‚¤ë¥¼ ì‹ ë¢°í•˜ë„ë¡ ì„¤ì •)
      - name: Add Host Key to Known Hosts
        run: ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      # 6ï¸âƒ£ DockerHub ë¡œê·¸ì¸ (Docker ì´ë¯¸ì§€ë¥¼ pushí•˜ê¸° ìœ„í•´ í•„ìš”)
      - name: DockerHub Login
        run: echo '${{ secrets.DOCKER_PASSWORD }}' | docker login -u '${{ secrets.DOCKER_USERNAME }}' --password-stdin

      # 7ï¸âƒ£ .env íŒŒì¼ ìƒì„± (í™˜ê²½ ë³€ìˆ˜ ì„¤ì •)
      - name: Create .env file
        run: |
          echo "DATABASE_HOST=${{ secrets.DATABASE_HOST }}" >> .env
          echo "DATABASE_NAME=${{ secrets.DATABASE_NAME }}" >> .env
          echo "DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}" >> .env
          echo "DATABASE_PORT=${{ secrets.DATABASE_PORT }}" >> .env
          echo "DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}" >> .env
          echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}" >> .env
          echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> .env

      # 8ï¸âƒ£ Docker Buildx ì„¤ì • (ë©€í‹° í”Œë«í¼ ë¹Œë“œ ì§€ì›)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 9ï¸âƒ£ BuildKit ë¹Œë” ìƒì„± ë° ì‚¬ìš© ì„¤ì •
      - name: Create BuildKit Builder
        run: |
          docker buildx create --use --name buildkit
          docker buildx use buildkit

      # ğŸ”¥ 10ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Docker Image Build
        run: |
          docker compose -f docker-compose.yml build --build-arg BUILDKIT_INLINE_CACHE=1

      # ğŸ”¥ 11ï¸âƒ£ Docker ì´ë¯¸ì§€ í‘¸ì‹œ (DockerHub ì—…ë¡œë“œ)
      - name: Docker Image Push
        run: |
          docker compose -f docker-compose.yml push

      # 12ï¸âƒ£ ì›ê²© ì„œë²„ì˜ SSH í‚¤ ë“±ë¡ (SSH í¬íŠ¸ í™•ì¸ í›„ ë“±ë¡)
      - name: Add Remote Server Fingerprint to Known Hosts
        run: ssh-keyscan -H -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts || true

      # 13ï¸âƒ£ Docker Compose íŒŒì¼ & .env íŒŒì¼ ì›ê²© ì„œë²„ë¡œ ë³µì‚¬
      - name: Copy .env / docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "docker-compose.yml,.env"
          target: "~/github-actions-work-directory"

      # ğŸ”¥ 14ï¸âƒ£ ì›ê²© ì„œë²„ì—ì„œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
      - name: Pull Image & Up Container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ~/github-actions-work-directory
            docker compose -f docker-compose.yml pull  # ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            docker compose -f docker-compose.yml down  # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
            docker compose -f docker-compose.yml up -d  # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰

            # ğŸ›‘ ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì‚­ì œ ì „, í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸
            echo "ğŸ”¥ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ëª©ë¡:"
            docker ps

            # ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì‚­ì œ (í™•ì¸ í›„ ì‹¤í–‰í•˜ë„ë¡ ìœ ë„)
            echo "âš ï¸ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì‚­ì œ ì¤‘..."
            docker system prune -f

      # âœ… 15ï¸âƒ£ Discord ì•Œë¦¼ (ë°°í¬ ì„±ê³µ)
      - name: Discord Notification - Success
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "âœ… ë°°í¬ ì„±ê³µ"
          description: |
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.event.head_commit.message }}
          color: 0x00ff00

      # âŒ 16ï¸âƒ£ Discord ì•Œë¦¼ (ë°°í¬ ì‹¤íŒ¨)
      - name: Discord Notification - Failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "âŒ ë°°í¬ ì‹¤íŒ¨"
          description: |
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.event.head_commit.message }}
          color: 0xff0000
